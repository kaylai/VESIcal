

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VESIcal.models.magmasat &mdash; VESIcal 1.2.6 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=77553476" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=010db75e"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quick_tutorials.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Verbose Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_tutorials.html">Advanced Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../youtube.html">YouTube Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../integration.html">Integration with Thermobar</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../codedoc.html">VESIcal Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQâ€™s</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">ChangeLog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About VESIcal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">MIT Licence</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../workshops.html">Workshops and Presentations</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/kaylai/VESIcal">GitHub Repo</a></li>
<li class="toctree-l1"><a class="reference external" href="https://linktr.ee/VESIcal">Link Tree</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">VESIcal</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../VESIcal.html">VESIcal</a></li>
      <li class="breadcrumb-item active">VESIcal.models.magmasat</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for VESIcal.models.magmasat</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">VESIcal</span> <span class="kn">import</span> <span class="n">calibration_checks</span>
<span class="kn">from</span> <span class="nn">VESIcal</span> <span class="kn">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">VESIcal</span> <span class="kn">import</span> <span class="n">model_classes</span>
<span class="kn">from</span> <span class="nn">VESIcal</span> <span class="kn">import</span> <span class="n">sample_class</span>
<span class="kn">from</span> <span class="nn">VESIcal</span> <span class="kn">import</span> <span class="n">vplot</span>
<span class="kn">from</span> <span class="nn">VESIcal</span> <span class="kn">import</span> <span class="n">batchfile</span>  <span class="c1"># needed for status_bar functions</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">warnings</span> <span class="k">as</span> <span class="nn">w</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># optional dependency thermoengine</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">thermoengine</span> <span class="kn">import</span> <span class="n">equilibrate</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">w</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
           <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> WARNING: Thermoengine is not installed. MagmaSat model will not function. A &quot;</span>
           <span class="s2">&quot;model name must be given when performing any calculation as &quot;</span>
           <span class="s2">&quot;model=</span><span class="se">\&#39;</span><span class="s2">some-model-name</span><span class="se">\&#39;</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">equilibrate</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># filter warnings</span>
<span class="n">w</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;rubicon.objc.ctypes_patch has only been tested &quot;</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;The handle&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="MagmaSat">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat">[docs]</a>
<span class="k">class</span> <span class="nc">MagmaSat</span><span class="p">(</span><span class="n">model_classes</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object to instantiate a thermoengine equilibrate class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">equilibrate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">core</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;ERROR: Thermoengine is not installed. MagmaSat model will not function. A &quot;</span>
                <span class="s2">&quot;model name must be given when performing any calculation as &quot;</span>
                <span class="s2">&quot;model=</span><span class="se">\&#39;</span><span class="s2">some-model-name</span><span class="se">\&#39;</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># -------------- MELTS preamble --------------- #</span>
        <span class="c1"># instantiate thermoengine equilibrate MELTS instance</span>
        <span class="n">melts</span> <span class="o">=</span> <span class="n">equilibrate</span><span class="o">.</span><span class="n">MELTSmodel</span><span class="p">(</span><span class="s2">&quot;1.2.0&quot;</span><span class="p">)</span>

        <span class="c1"># Suppress phases not required in the melts simulation</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">melts</span><span class="o">.</span><span class="n">get_phase_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
            <span class="n">melts</span><span class="o">.</span><span class="n">set_phase_inclusion_status</span><span class="p">({</span><span class="n">phase</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="n">melts</span><span class="o">.</span><span class="n">set_phase_inclusion_status</span><span class="p">({</span><span class="s2">&quot;Fluid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Liquid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span> <span class="o">=</span> <span class="n">melts</span>
        <span class="c1"># --------------------------------------------- #</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melts_version</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;1.2.0&quot;</span>  <span class="c1"># just here so users can see which version is being used</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_volatile_species</span><span class="p">([</span><span class="s2">&quot;H2O&quot;</span><span class="p">,</span> <span class="s2">&quot;CO2&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_calibration_ranges</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">calibration_checks</span><span class="o">.</span><span class="n">CalibrationRange</span><span class="p">(</span>
                    <span class="s2">&quot;pressure&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">20000.0</span><span class="p">],</span>
                    <span class="n">calibration_checks</span><span class="o">.</span><span class="n">crf_Between</span><span class="p">,</span>
                    <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;MagmaSat&quot;</span><span class="p">,</span>
                    <span class="n">fail_msg</span><span class="o">=</span><span class="n">calibration_checks</span><span class="o">.</span><span class="n">crmsg_Between_fail</span><span class="p">,</span>
                    <span class="n">pass_msg</span><span class="o">=</span><span class="n">calibration_checks</span><span class="o">.</span><span class="n">crmsg_Between_pass</span><span class="p">,</span>
                    <span class="n">description_msg</span><span class="o">=</span><span class="n">calibration_checks</span><span class="o">.</span><span class="n">crmsg_Between_description</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">calibration_checks</span><span class="o">.</span><span class="n">CalibrationRange</span><span class="p">(</span>
                    <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
                    <span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">1400</span><span class="p">],</span>
                    <span class="n">calibration_checks</span><span class="o">.</span><span class="n">crf_Between</span><span class="p">,</span>
                    <span class="s2">&quot;oC&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;MagmaSat&quot;</span><span class="p">,</span>
                    <span class="n">fail_msg</span><span class="o">=</span><span class="n">calibration_checks</span><span class="o">.</span><span class="n">crmsg_Between_fail</span><span class="p">,</span>
                    <span class="n">pass_msg</span><span class="o">=</span><span class="n">calibration_checks</span><span class="o">.</span><span class="n">crmsg_Between_pass</span><span class="p">,</span>
                    <span class="n">description_msg</span><span class="o">=</span><span class="n">calibration_checks</span><span class="o">.</span><span class="n">crmsg_Between_description</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;MagmaSat&quot;</span>

<div class="viewcode-block" id="MagmaSat.preprocess_sample">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.preprocess_sample">[docs]</a>
    <span class="k">def</span> <span class="nf">preprocess_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns sample with 0.0 values for any oxides not passed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample:     Sample class</span>
<span class="sd">            Magma major element composition.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Sample class object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_sample</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A &quot;fixedvolatiles&quot; normalization must be applied here to achieve consistent behavior</span>
<span class="sd">        with MagmaSat and between VESIcal calculations. See pull reqeust from 23 June 2022</span>
<span class="sd">        for discussion of this issue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_sample</span> <span class="o">=</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span>
            <span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">,</span>
            <span class="n">normalization</span><span class="o">=</span><span class="s2">&quot;fixedvolatiles&quot;</span><span class="p">,</span>
            <span class="n">asSampleClass</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># set any necessary magmasat oxides to 0 if no value given</span>
        <span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">magmasat_oxides</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_sample</span><span class="o">.</span><span class="n">change_composition</span><span class="p">({</span><span class="n">oxide</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">})</span>

        <span class="c1"># remove any non-magmasat oxides</span>
        <span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oxide</span> <span class="ow">in</span> <span class="n">core</span><span class="o">.</span><span class="n">magmasat_oxides</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_sample</span><span class="o">.</span><span class="n">delete_oxide</span><span class="p">(</span><span class="n">oxide</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp_orig</span> <span class="o">=</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_sample</span></div>


<div class="viewcode-block" id="MagmaSat.check_calibration_range">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.check_calibration_range">[docs]</a>
    <span class="k">def</span> <span class="nf">check_calibration_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks whether supplied parameters and calculated results are within the calibration</span>
<span class="sd">        range of the model, defined by the CalibrationRange objects. An empty string will be</span>
<span class="sd">        returned if all parameters are within the calibration range. If a parameter is not within</span>
<span class="sd">        the calibration range, a description of the problem will be returned in the string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters     dict</span>
<span class="sd">            Dictionary keys are the names of the parameters to be checked, e.g., pressure</span>
<span class="sd">            temperature, SiO2, etc. Values are the values of each parameter. A complete set</span>
<span class="sd">            need not be given.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            String description of any parameters falling outside of the calibration range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_ranges</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">cr</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">report_nonexistance</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;notsaturated&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Sample not saturated at these conditions.&quot;</span>
        <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="MagmaSat.get_calibration_range">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.get_calibration_range">[docs]</a>
    <span class="k">def</span> <span class="nf">get_calibration_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a string describing the calibration ranges defined by the CalibrationRange</span>
<span class="sd">        objects for the model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            String description of the calibration range objects.&quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_ranges</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">cr</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="MagmaSat.get_fluid_mass">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.get_fluid_mass">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fluid_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O</span><span class="p">,</span> <span class="n">CO2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An internally used function to calculate fluid mass.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample:     Sample class</span>
<span class="sd">            Magma major element composition.</span>

<span class="sd">        temperature: float</span>
<span class="sd">            Temperature in degrees C.</span>

<span class="sd">        pressure: float</span>
<span class="sd">            Pressure in bars</span>

<span class="sd">        H2O: float</span>
<span class="sd">            wt% H2O in the system</span>

<span class="sd">        CO2: float</span>
<span class="sd">            wt% CO2 in the system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            mass of the fluid in grams</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pressureMPa</span> <span class="o">=</span> <span class="n">pressure</span> <span class="o">/</span> <span class="mf">10.0</span>

        <span class="n">bulk_comp_dict</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">)</span>
        <span class="n">bulk_comp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">oxide</span><span class="p">:</span> <span class="n">bulk_comp_dict</span><span class="p">[</span><span class="n">oxide</span><span class="p">]</span> <span class="k">for</span> <span class="n">oxide</span> <span class="ow">in</span>
                          <span class="n">core</span><span class="o">.</span><span class="n">magmasat_oxides</span><span class="p">}</span>
        <span class="n">bulk_comp_dict</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">H2O</span>
        <span class="n">bulk_comp_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CO2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bulk_comp_dict</span><span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fluid_mass</span></div>


<div class="viewcode-block" id="MagmaSat.get_XH2O_fluid">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.get_XH2O_fluid">[docs]</a>
    <span class="k">def</span> <span class="nf">get_XH2O_fluid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O</span><span class="p">,</span> <span class="n">CO2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An internally used function to calculate fluid composition.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample:     Sample class</span>
<span class="sd">            Magma major element composition.</span>

<span class="sd">        temperature: float</span>
<span class="sd">            Temperature in degrees C.</span>

<span class="sd">        pressure: float</span>
<span class="sd">            Pressure in bars</span>

<span class="sd">        H2O: float</span>
<span class="sd">            wt% H2O in the system</span>

<span class="sd">        CO2: float</span>
<span class="sd">            wt% CO2 in the system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Mole fraction of H2O in the H2O-CO2 fluid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

        <span class="n">pressureMPa</span> <span class="o">=</span> <span class="n">pressure</span> <span class="o">/</span> <span class="mf">10.0</span>

        <span class="n">_sample</span><span class="o">.</span><span class="n">change_composition</span><span class="p">({</span><span class="s2">&quot;H2O&quot;</span><span class="p">:</span> <span class="n">H2O</span><span class="p">,</span> <span class="s2">&quot;CO2&quot;</span><span class="p">:</span> <span class="n">CO2</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span>
            <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fluid_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span>
            <span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;component&quot;</span>
        <span class="p">)</span>
        <span class="c1"># NOTE mode=&#39;component&#39; returns endmember component keys with values in mol fraction.</span>

        <span class="k">if</span> <span class="s2">&quot;Water&quot;</span> <span class="ow">in</span> <span class="n">fluid_comp</span><span class="p">:</span>
            <span class="n">H2O_fl</span> <span class="o">=</span> <span class="n">fluid_comp</span><span class="p">[</span><span class="s2">&quot;Water&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H2O_fl</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="n">H2O_fl</span></div>


<div class="viewcode-block" id="MagmaSat.calculate_dissolved_volatiles">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.calculate_dissolved_volatiles">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_dissolved_volatiles</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">,</span>
        <span class="n">pressure</span><span class="p">,</span>
        <span class="n">X_fluid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">H2O_guess</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the amount of H2O and CO2 dissolved in a magma at saturation at the given P/T</span>
<span class="sd">        conditions and fluid composition. Fluid composition will be matched to within 0.0001 mole</span>
<span class="sd">        fraction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample:     Sample class</span>
<span class="sd">            Magma major element composition.</span>

<span class="sd">        temperature: float or int</span>
<span class="sd">            Temperature, in degrees C.</span>

<span class="sd">        presure: float or int</span>
<span class="sd">            Pressure, in bars.</span>

<span class="sd">        X_fluid: float or int</span>
<span class="sd">            The default value is 1. The mole fraction of H2O in the H2O-CO2 fluid. X_fluid=1 is a</span>
<span class="sd">            pure H2O fluid. X_fluid=0 is a pure CO2 fluid.</span>

<span class="sd">        verbose: bool</span>
<span class="sd">            OPTIONAL: Default is False. If set to True, returns H2O and CO2 concentration in the</span>
<span class="sd">            melt, H2O and CO2 concentration in the fluid, mass of the fluid in grams, and</span>
<span class="sd">            proportion of fluid in the system in wt%.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary of dissolved volatile concentrations in wt% with keys H2O and CO2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_fluid</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_fluid</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">core</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;X_fluid must be type int or float&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">H2O_guess</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">H2O_guess</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">core</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;H2O_guess must be type int or float&quot;</span><span class="p">)</span>

        <span class="n">pressureMPa</span> <span class="o">=</span> <span class="n">pressure</span> <span class="o">/</span> <span class="mf">10.0</span>

        <span class="k">if</span> <span class="n">X_fluid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">X_fluid</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">X_fluid</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="ow">or</span> <span class="n">X_fluid</span> <span class="o">&gt;</span> <span class="mf">0.999</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">core</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span>
                    <span class="s2">&quot;X_fluid is calculated to a precision of 0.0001 mole &quot;</span>
                    <span class="s2">&quot;fraction. Value for X_fluid must be between 0.0001 and &quot;</span>
                    <span class="s2">&quot;0.9999.&quot;</span>
                <span class="p">)</span>

        <span class="n">H2O_val</span> <span class="o">=</span> <span class="n">H2O_guess</span>
        <span class="n">CO2_val</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">fluid_mass</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">while</span> <span class="n">fluid_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">X_fluid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">CO2_val</span> <span class="o">+=</span> <span class="mf">0.1</span>
            <span class="k">elif</span> <span class="n">X_fluid</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">H2O_val</span> <span class="o">+=</span> <span class="mf">0.2</span>
                <span class="c1"># NOTE this is setting XH2Owt of the system (not of the fluid) to X_fluid</span>
                <span class="n">CO2_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">H2O_val</span> <span class="o">/</span> <span class="n">X_fluid</span><span class="p">)</span> <span class="o">-</span> <span class="n">H2O_val</span>
                <span class="c1"># TODO this is what needs to be higher for higher XH2O. Slows down computation</span>
                <span class="c1"># by a second or two</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H2O_val</span> <span class="o">+=</span> <span class="mf">0.1</span>
                <span class="c1"># NOTE this is setting XH2Owt of the system (not of the fluid) to X_fluid</span>
                <span class="n">CO2_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">H2O_val</span> <span class="o">/</span> <span class="n">X_fluid</span><span class="p">)</span> <span class="o">-</span> <span class="n">H2O_val</span>
                <span class="c1"># TODO this is what needs to be higher for higher XH2O. Slows down computation</span>
                <span class="c1"># by a second or two</span>

            <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluid_mass</span><span class="p">(</span>
                <span class="n">_sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="n">CO2_val</span>
            <span class="p">)</span>

        <span class="n">_sample</span><span class="o">.</span><span class="n">change_composition</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;H2O&quot;</span><span class="p">:</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="s2">&quot;CO2&quot;</span><span class="p">:</span> <span class="n">CO2_val</span><span class="p">},</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span>
            <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">liquid_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span>
            <span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Liquid&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;oxide_wt&quot;</span>
        <span class="p">)</span>
        <span class="n">fluid_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span>
            <span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;component&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Water&quot;</span> <span class="ow">in</span> <span class="n">fluid_comp</span><span class="p">:</span>
            <span class="n">H2O_fl</span> <span class="o">=</span> <span class="n">fluid_comp</span><span class="p">[</span><span class="s2">&quot;Water&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H2O_fl</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="n">H2O_fl</span>

        <span class="c1"># ------ Coarse Check ------ #</span>
        <span class="k">while</span> <span class="n">XH2O_fluid</span> <span class="o">&lt;</span> <span class="n">X_fluid</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># too low coarse check</span>
            <span class="n">H2O_val</span> <span class="o">+=</span> <span class="mf">0.2</span>
            <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_XH2O_fluid</span><span class="p">(</span>
                <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="n">CO2_val</span>
            <span class="p">)</span>

        <span class="k">while</span> <span class="n">XH2O_fluid</span> <span class="o">&gt;</span> <span class="n">X_fluid</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># too high coarse check</span>
            <span class="n">CO2_val</span> <span class="o">+=</span> <span class="mf">0.1</span>
            <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_XH2O_fluid</span><span class="p">(</span>
                <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="n">CO2_val</span>
            <span class="p">)</span>

        <span class="c1"># ------ Refinement 1 ------ #</span>
        <span class="k">while</span> <span class="n">XH2O_fluid</span> <span class="o">&lt;</span> <span class="n">X_fluid</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># too low refinement 1</span>
            <span class="n">H2O_val</span> <span class="o">+=</span> <span class="mf">0.05</span>
            <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_XH2O_fluid</span><span class="p">(</span>
                <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="n">CO2_val</span>
            <span class="p">)</span>

        <span class="k">while</span> <span class="n">XH2O_fluid</span> <span class="o">&gt;</span> <span class="n">X_fluid</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="c1"># too high refinement 1</span>
            <span class="n">CO2_val</span> <span class="o">+=</span> <span class="mf">0.01</span>
            <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_XH2O_fluid</span><span class="p">(</span>
                <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="n">CO2_val</span>
            <span class="p">)</span>

        <span class="c1"># ------ Refinement 2 ------ #</span>
        <span class="k">while</span> <span class="n">XH2O_fluid</span> <span class="o">&lt;</span> <span class="n">X_fluid</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">:</span>  <span class="c1"># too low refinement 2</span>
            <span class="n">H2O_val</span> <span class="o">+=</span> <span class="mf">0.005</span>
            <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_XH2O_fluid</span><span class="p">(</span>
                <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="n">CO2_val</span>
            <span class="p">)</span>

        <span class="k">while</span> <span class="n">XH2O_fluid</span> <span class="o">&gt;</span> <span class="n">X_fluid</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">:</span>  <span class="c1"># too high refinement 2</span>
            <span class="n">CO2_val</span> <span class="o">+=</span> <span class="mf">0.001</span>
            <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_XH2O_fluid</span><span class="p">(</span>
                <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="n">CO2_val</span>
            <span class="p">)</span>

        <span class="c1"># ------ Final refinement ------ #</span>
        <span class="k">while</span> <span class="n">XH2O_fluid</span> <span class="o">&lt;</span> <span class="n">X_fluid</span> <span class="o">-</span> <span class="mf">0.0001</span><span class="p">:</span>  <span class="c1"># too low final refinement</span>
            <span class="n">H2O_val</span> <span class="o">+=</span> <span class="mf">0.001</span>
            <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_XH2O_fluid</span><span class="p">(</span>
                <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="n">CO2_val</span>
            <span class="p">)</span>

        <span class="k">while</span> <span class="n">XH2O_fluid</span> <span class="o">&gt;</span> <span class="n">X_fluid</span> <span class="o">+</span> <span class="mf">0.0001</span><span class="p">:</span>  <span class="c1"># too high final refinement</span>
            <span class="n">CO2_val</span> <span class="o">+=</span> <span class="mf">0.0001</span>
            <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_XH2O_fluid</span><span class="p">(</span>
                <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="n">CO2_val</span>
            <span class="p">)</span>

        <span class="c1"># ------ Get calculated values ------ #</span>
        <span class="n">_sample</span><span class="o">.</span><span class="n">change_composition</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;H2O&quot;</span><span class="p">:</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="s2">&quot;CO2&quot;</span><span class="p">:</span> <span class="n">CO2_val</span><span class="p">},</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span>
            <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>
        <span class="n">system_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;System&quot;</span><span class="p">)</span>
        <span class="n">liquid_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span>
            <span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Liquid&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;oxide_wt&quot;</span>
        <span class="p">)</span>
        <span class="n">fluid_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span>
            <span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;component&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;H2O&quot;</span> <span class="ow">in</span> <span class="n">liquid_comp</span><span class="p">:</span>
            <span class="n">H2O_liq</span> <span class="o">=</span> <span class="n">liquid_comp</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H2O_liq</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;CO2&quot;</span> <span class="ow">in</span> <span class="n">liquid_comp</span><span class="p">:</span>
            <span class="n">CO2_liq</span> <span class="o">=</span> <span class="n">liquid_comp</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CO2_liq</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;Water&quot;</span> <span class="ow">in</span> <span class="n">fluid_comp</span><span class="p">:</span>
            <span class="n">H2O_fl</span> <span class="o">=</span> <span class="n">fluid_comp</span><span class="p">[</span><span class="s2">&quot;Water&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H2O_fl</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="s2">&quot;Carbon Dioxide&quot;</span> <span class="ow">in</span> <span class="n">fluid_comp</span><span class="p">:</span>
            <span class="n">CO2_fl</span> <span class="o">=</span> <span class="n">fluid_comp</span><span class="p">[</span><span class="s2">&quot;Carbon Dioxide&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CO2_fl</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="n">H2O_fl</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">temperature</span><span class="p">,</span>
                <span class="s2">&quot;pressure&quot;</span><span class="p">:</span> <span class="n">pressure</span><span class="p">,</span>
                <span class="s2">&quot;H2O_liq&quot;</span><span class="p">:</span> <span class="n">H2O_liq</span><span class="p">,</span>
                <span class="s2">&quot;CO2_liq&quot;</span><span class="p">:</span> <span class="n">CO2_liq</span><span class="p">,</span>
                <span class="s2">&quot;XH2O_fl&quot;</span><span class="p">:</span> <span class="n">H2O_fl</span><span class="p">,</span>
                <span class="s2">&quot;XCO2_fl&quot;</span><span class="p">:</span> <span class="n">CO2_fl</span><span class="p">,</span>
                <span class="s2">&quot;FluidProportion_wt&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">fluid_mass</span> <span class="o">/</span> <span class="n">system_mass</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;CO2_liq&quot;</span><span class="p">:</span> <span class="n">CO2_liq</span><span class="p">,</span> <span class="s2">&quot;H2O_liq&quot;</span><span class="p">:</span> <span class="n">H2O_liq</span><span class="p">}</span></div>


<div class="viewcode-block" id="MagmaSat.calculate_equilibrium_fluid_comp">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.calculate_equilibrium_fluid_comp">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_equilibrium_fluid_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns H2O and CO2 concentrations in wt% in a fluid in equilibrium with the given sample</span>
<span class="sd">        at the given P/T condition.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample:     Sample class</span>
<span class="sd">            Magma major element composition.</span>

<span class="sd">        temperature: float or int</span>
<span class="sd">            Temperature, in degrees C.</span>

<span class="sd">        presure: float or int</span>
<span class="sd">            Pressure, in bars.</span>

<span class="sd">        verbose: bool</span>
<span class="sd">            OPTIONAL: Default is False. If set to True, returns H2O and CO2 concentration in the</span>
<span class="sd">            fluid in mole fraction, mass of the fluid in grams, and proportion of fluid in the</span>
<span class="sd">            system in wt%.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary of fluid composition in wt% with keys &#39;H2O&#39; and &#39;CO2&#39; is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">bulk_comp_dict</span> <span class="o">=</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">core</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;temp must be type float or int&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">core</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;presure must be type float or int&quot;</span><span class="p">)</span>

        <span class="c1"># Check if only single volatile species is passed. If so, can skip calculations.</span>
        <span class="k">if</span> <span class="n">bulk_comp_dict</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bulk_comp_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;CO2&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;H2O&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;CO2&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;H2O&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;FluidMass_grams&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                        <span class="s2">&quot;FluidProportion_wt&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;CO2&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;H2O&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bulk_comp_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;CO2&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;H2O&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>

        <span class="n">pressureMPa</span> <span class="o">=</span> <span class="n">pressure</span> <span class="o">/</span> <span class="mf">10.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bulk_comp_dict</span><span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>
        <span class="n">flsystem_wtper</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">100</span>
            <span class="o">*</span> <span class="n">fluid_mass</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">fluid_mass</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Liquid&quot;</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">fluid_mass</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">fluid_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span>
                <span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;component&quot;</span>
            <span class="p">)</span>
            <span class="n">fluid_comp_H2O</span> <span class="o">=</span> <span class="n">fluid_comp</span><span class="p">[</span><span class="s2">&quot;Water&quot;</span><span class="p">]</span>
            <span class="n">fluid_comp_CO2</span> <span class="o">=</span> <span class="n">fluid_comp</span><span class="p">[</span><span class="s2">&quot;Carbon Dioxide&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fluid_comp_H2O</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fluid_comp_CO2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp_orig</span><span class="p">)</span>  <span class="c1"># reset</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">simple_return</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CO2&quot;</span><span class="p">:</span> <span class="n">fluid_comp_CO2</span><span class="p">,</span> <span class="s2">&quot;H2O&quot;</span><span class="p">:</span> <span class="n">fluid_comp_H2O</span><span class="p">}</span>
            <span class="n">simple_return</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">simple_return</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">simple_return</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">verbose_return</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;CO2&quot;</span><span class="p">:</span> <span class="n">fluid_comp_CO2</span><span class="p">,</span>
                <span class="s2">&quot;H2O&quot;</span><span class="p">:</span> <span class="n">fluid_comp_H2O</span><span class="p">,</span>
                <span class="s2">&quot;FluidMass_grams&quot;</span><span class="p">:</span> <span class="n">fluid_mass</span><span class="p">,</span>
                <span class="s2">&quot;FluidProportion_wt&quot;</span><span class="p">:</span> <span class="n">flsystem_wtper</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">verbose_return</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">verbose_return</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">verbose_return</span></div>


<div class="viewcode-block" id="MagmaSat.calculate_saturation_pressure">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.calculate_saturation_pressure">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_saturation_pressure</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the saturation pressure of a sample composition.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample:     Sample class</span>
<span class="sd">            Magma major element composition.</span>

<span class="sd">        temperature: flaot or int</span>
<span class="sd">            Temperature of the sample in degrees C.</span>

<span class="sd">        verbose: bool</span>
<span class="sd">            OPTIONAL: Default is False. If set to False, only the saturation pressure is returned.</span>
<span class="sd">            If set to True, the saturation pressure, mass of fluid in grams, proportion of fluid</span>
<span class="sd">            in wt%, and H2O and CO2 concentrations in the fluid in mole fraction are all returned</span>
<span class="sd">            in a dict.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float or dict</span>
<span class="sd">            If verbose is set to False: Saturation pressure in bars.</span>
<span class="sd">            If verbose is set to True: dict of all calculated values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">bulk_comp</span> <span class="o">=</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bulk_comp</span><span class="p">)</span>

        <span class="c1"># Coarse search</span>
        <span class="c1"># NOTE that pressure is in MPa for MagmaSat calculations but reported in bars.</span>
        <span class="n">pressureMPa</span> <span class="o">=</span> <span class="mi">2000</span>

        <span class="c1"># Check if saturated at 2000 MPa (rare, for deep samples)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span>
                                           <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fluid_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if not sat&#39;d at 2000 MPa</span>
            <span class="k">while</span> <span class="n">fluid_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pressureMPa</span> <span class="o">-=</span> <span class="mi">100</span>
                <span class="k">if</span> <span class="n">pressureMPa</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># composition needs to be reset for each refinement</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bulk_comp</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span>
                                                   <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>

            <span class="n">fluid_mass</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pressureMPa</span> <span class="o">+=</span> <span class="mi">100</span>
        <span class="k">elif</span> <span class="n">fluid_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if sat&#39;d at 2000 MPa, add pressure</span>
            <span class="k">while</span> <span class="n">fluid_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pressureMPa</span> <span class="o">+=</span> <span class="mi">100</span>

                <span class="c1"># composition needs to be reset for each refinement</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bulk_comp</span><span class="p">)</span>

                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>

            <span class="n">fluid_mass</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">pressureMPa</span> <span class="o">-=</span> <span class="mi">100</span>
        <span class="c1"># Refined search 1</span>
        <span class="k">if</span> <span class="n">fluid_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># proceed down pressure search</span>
            <span class="k">while</span> <span class="n">fluid_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pressureMPa</span> <span class="o">-=</span> <span class="mi">10</span>
                <span class="k">if</span> <span class="n">pressureMPa</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># composition needs to be reset for each refinement</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bulk_comp</span><span class="p">)</span>

                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span>
                                                   <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span>
                                                          <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>

            <span class="n">fluid_mass</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pressureMPa</span> <span class="o">+=</span> <span class="mi">10</span>
        <span class="k">elif</span> <span class="n">fluid_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># proceed upward pressure search</span>
            <span class="k">while</span> <span class="n">fluid_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pressureMPa</span> <span class="o">+=</span> <span class="mi">10</span>

                <span class="c1"># composition needs to be reset for each refinement</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bulk_comp</span><span class="p">)</span>

                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span>
                                                   <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span>
                                                          <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>

            <span class="n">fluid_mass</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">pressureMPa</span> <span class="o">-=</span> <span class="mi">10</span>

        <span class="c1"># Refined search 2</span>
        <span class="k">if</span> <span class="n">fluid_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># proceed down pressure search</span>
            <span class="k">while</span> <span class="n">fluid_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pressureMPa</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">pressureMPa</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># composition needs to be reset for each refinement</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bulk_comp</span><span class="p">)</span>

                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span>
                                                   <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span>
                                                          <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>

            <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">fluid_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># proceed upward pressure search</span>
            <span class="k">while</span> <span class="n">fluid_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pressureMPa</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># composition needs to be reset for each refinement</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">bulk_comp</span><span class="p">)</span>

                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span>
                                                   <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span>
                                                          <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pressureMPa</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
            <span class="n">satP</span> <span class="o">=</span> <span class="n">pressureMPa</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># convert pressure to bars</span>
            <span class="n">flmass</span> <span class="o">=</span> <span class="n">fluid_mass</span>
            <span class="n">flsystem_wtper</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">fluid_mass</span>
                              <span class="o">/</span> <span class="p">(</span><span class="n">fluid_mass</span> <span class="o">+</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span>
                                                              <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Liquid&quot;</span><span class="p">)))</span>
            <span class="n">flcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span>
                                                         <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">,</span>
                                                         <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;component&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">flH2O</span> <span class="o">=</span> <span class="n">flcomp</span><span class="p">[</span><span class="s2">&quot;Water&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">flH2O</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">flCO2</span> <span class="o">=</span> <span class="n">flcomp</span><span class="p">[</span><span class="s2">&quot;Carbon Dioxide&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">flCO2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flmass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">flsystem_wtper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">flH2O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">flCO2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">warnmessage</span> <span class="o">=</span> <span class="s2">&quot;Calculation failed.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp_orig</span><span class="p">)</span>  <span class="c1"># this needs to be reset always!</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnmessage</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">satP</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnmessage</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">verbose_return</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;SaturationP_bars&quot;</span><span class="p">:</span> <span class="n">satP</span><span class="p">,</span>
                <span class="s2">&quot;FluidMass_grams&quot;</span><span class="p">:</span> <span class="n">flmass</span><span class="p">,</span>
                <span class="s2">&quot;FluidProportion_wt&quot;</span><span class="p">:</span> <span class="n">flsystem_wtper</span><span class="p">,</span>
                <span class="s2">&quot;XH2O_fl&quot;</span><span class="p">:</span> <span class="n">flH2O</span><span class="p">,</span>
                <span class="s2">&quot;XCO2_fl&quot;</span><span class="p">:</span> <span class="n">flCO2</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">verbose_return</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">verbose_return</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">verbose_return</span></div>


<div class="viewcode-block" id="MagmaSat.calculate_isobars_and_isopleths">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.calculate_isobars_and_isopleths">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_isobars_and_isopleths</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">,</span>
        <span class="n">pressure_list</span><span class="p">,</span>
        <span class="n">isopleth_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">smooth_isobars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">smooth_isopleths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">print_status</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates isobars and isopleths at a constant temperature for a given sample. Isobars can</span>
<span class="sd">        be calculated for any number of pressures. Isobars are calculated using 5 XH2O values</span>
<span class="sd">        (0, 0.25, 0.5, 0.75, 1).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample:     Sample class</span>
<span class="sd">            Magma major element composition.</span>

<span class="sd">        temperature: float</span>
<span class="sd">            Temperature in degrees C.</span>

<span class="sd">        pressure_list: list or float</span>
<span class="sd">            List of all pressure values at which to calculate isobars, in bars. If only one value</span>
<span class="sd">            is passed it can be as float instead of list.</span>

<span class="sd">        isopleth_list: list or float</span>
<span class="sd">            OPTIONAL: Default value is None in which case only isobars will be calculated.</span>
<span class="sd">            List of all fluid compositions in mole fraction H2O (XH2Ofluid) at which to calcualte</span>
<span class="sd">            isopleths. Values can range from 0-1. If only one value is passed it can be as float</span>
<span class="sd">            instead of list.</span>

<span class="sd">        smooth_isobars: bool</span>
<span class="sd">            OPTIONAL. Default is True. If set to True, polynomials will be fit to the computed</span>
<span class="sd">            isobar points.</span>

<span class="sd">        smooth_isopleths: bool</span>
<span class="sd">            OPTIONAL. Default is True. If set to True, polynomials will be fit to the computed</span>
<span class="sd">            isopleth points.</span>

<span class="sd">        print_status: bool</span>
<span class="sd">            OPTIONAL: Default is True. If set to True, progress of the calculations will be</span>
<span class="sd">            printed to the terminal.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas DataFrame objects</span>
<span class="sd">            Two pandas DataFrames are returned; the first has isobar data, and the second has</span>
<span class="sd">            isopleth data. Columns in the isobar dataframe are &#39;Pressure&#39;, &#39;H2Omelt&#39;, and</span>
<span class="sd">            &#39;CO2melt&#39;, correpsonding to pressure in bars and dissolved H2O and CO2 in the liquid</span>
<span class="sd">            in wt%. Columns in the isopleth dataframe are &#39;Pressure&#39;, &#39;H2Ofl&#39;, and &#39;CO2fl&#39;,</span>
<span class="sd">            corresponding to pressure in bars and H2O and CO2 concentration in the H2O-CO2 fluid,</span>
<span class="sd">            in wt%.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">P_vals</span> <span class="o">=</span> <span class="n">pressure_list</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure_list</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure_list</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">P_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">pressure_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">core</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;pressure_list must be a single float (1000.0), int (1000), or &quot;</span>
                                  <span class="s2">&quot;list of those [1000, 2000.0, 3000].&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">isopleth_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">isopleth_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">iso_vals</span> <span class="o">=</span> <span class="n">isopleth_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iso_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">isopleth_list</span><span class="p">]</span>

        <span class="n">_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

        <span class="n">required_iso_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">all_iso_vals</span> <span class="o">=</span> <span class="n">iso_vals</span> <span class="o">+</span> <span class="n">required_iso_vals</span>
        <span class="n">all_iso_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">all_iso_vals</span><span class="p">))</span>  <span class="c1"># remove duplicates</span>
        <span class="n">all_iso_vals</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># sort from smallest to largest</span>

        <span class="n">isobar_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">isopleth_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">iso_vals</span><span class="p">:</span>
            <span class="n">isopleth_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="c1"># Calculate equilibrium phase assemblage for all P/T conditions, check if saturated in</span>
        <span class="c1"># fluid...</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">P_vals</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">print_status</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating isobar at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; bars&quot;</span><span class="p">)</span>
            <span class="n">X_iter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">all_iso_vals</span><span class="p">:</span>
                <span class="n">X_iter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">print_status</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">isopleth_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">iso_vals</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\r</span><span class="s2"> Calculating isopleth at XH2Ofluid = &quot;</span>
                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                            <span class="o">+</span> <span class="s2">&quot;               &quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">X</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iso_vals</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\r</span><span class="s2"> Calculating isobar control point at XH2Ofluid = &quot;</span>
                            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
                            <span class="o">+</span> <span class="s2">&quot;               &quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">X_iter</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_iso_vals</span><span class="p">):</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\r</span><span class="s2"> done.                                               &quot;</span>
                            <span class="s2">&quot;                                                       &quot;</span>
                            <span class="s2">&quot;                     </span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                <span class="n">saturated_vols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_dissolved_volatiles</span><span class="p">(</span>
                    <span class="n">sample</span><span class="o">=</span><span class="n">_sample</span><span class="p">,</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                    <span class="n">pressure</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                    <span class="n">H2O_guess</span><span class="o">=</span><span class="n">guess</span><span class="p">,</span>
                    <span class="n">X_fluid</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">required_iso_vals</span><span class="p">:</span>
                    <span class="n">isobar_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">saturated_vols</span><span class="p">[</span><span class="s2">&quot;H2O_liq&quot;</span><span class="p">],</span> <span class="n">saturated_vols</span><span class="p">[</span><span class="s2">&quot;CO2_liq&quot;</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">iso_vals</span><span class="p">:</span>
                    <span class="n">isopleth_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">saturated_vols</span><span class="p">[</span><span class="s2">&quot;H2O_liq&quot;</span><span class="p">],</span> <span class="n">saturated_vols</span><span class="p">[</span><span class="s2">&quot;CO2_liq&quot;</span><span class="p">]])</span>

                <span class="n">guess</span> <span class="o">=</span> <span class="n">saturated_vols</span><span class="p">[</span><span class="s2">&quot;H2O_liq&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">print_status</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

        <span class="n">isobars_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">isobar_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Pressure&quot;</span><span class="p">,</span> <span class="s2">&quot;H2O_liq&quot;</span><span class="p">,</span> <span class="s2">&quot;CO2_liq&quot;</span><span class="p">])</span>
        <span class="n">isopleths_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">isopleth_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;XH2O_fl&quot;</span><span class="p">,</span> <span class="s2">&quot;H2O_liq&quot;</span><span class="p">,</span> <span class="s2">&quot;CO2_liq&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp_orig</span><span class="p">)</span>  <span class="c1"># reset</span>

        <span class="k">if</span> <span class="n">smooth_isobars</span><span class="p">:</span>
            <span class="n">isobars_smoothed</span> <span class="o">=</span> <span class="n">vplot</span><span class="o">.</span><span class="n">smooth_isobars_and_isopleths</span><span class="p">(</span><span class="n">isobars</span><span class="o">=</span><span class="n">isobars_df</span><span class="p">)</span>
            <span class="n">res_isobars</span> <span class="o">=</span> <span class="n">isobars_smoothed</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_isobars</span> <span class="o">=</span> <span class="n">isobars_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">smooth_isopleths</span><span class="p">:</span>
            <span class="n">isopleths_smoothed</span> <span class="o">=</span> <span class="n">vplot</span><span class="o">.</span><span class="n">smooth_isobars_and_isopleths</span><span class="p">(</span><span class="n">isopleths</span><span class="o">=</span><span class="n">isopleths_df</span><span class="p">)</span>
            <span class="n">res_isopleths</span> <span class="o">=</span> <span class="n">isopleths_smoothed</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_isopleths</span> <span class="o">=</span> <span class="n">isopleths_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">res_isobars</span><span class="p">,</span> <span class="n">res_isopleths</span></div>


<div class="viewcode-block" id="MagmaSat.calculate_degassing_path">
<a class="viewcode-back" href="../../../codedoc.html#VESIcal.models.magmasat.MagmaSat.calculate_degassing_path">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_degassing_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="s2">&quot;saturation&quot;</span><span class="p">,</span>
                                 <span class="n">fractionate_vapor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">init_vapor</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">final_pressure</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                 <span class="n">steps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates degassing path for one sample</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample:     Sample class</span>
<span class="sd">            Magma major element composition.</span>

<span class="sd">            Legacy info follows, might still be useful?</span>
<span class="sd">            If pulling from an uploaded file</span>
<span class="sd">            with data for many samples, first call get_sample_composition() to get the sample</span>
<span class="sd">            desired. Then pass the result into this function.</span>

<span class="sd">        temperature: float</span>
<span class="sd">            Temperature at which to calculate degassing paths, in degrees C.</span>

<span class="sd">        pressure: string, float, int, list, or numpy array</span>
<span class="sd">            OPTIONAL. The perssure at which to begin the degassing calculations. Default value is</span>
<span class="sd">            &#39;saturation&#39;, which runs the calculation with the initial pressure at the saturation</span>
<span class="sd">            pressure. If a pressure greater than the saturation pressure is input, the calculation</span>
<span class="sd">            will start at saturation, since this is the first pressure at which any degassing will</span>
<span class="sd">            occur.</span>

<span class="sd">        fractionate_vapor: float</span>
<span class="sd">            OPTIONAL. Proportion of vapor removed at each pressure step.</span>
<span class="sd">            Default value is 0.0 (completely closed-system degassing). Specifies the type of</span>
<span class="sd">            calculation performed, either closed system (0.0) or open system (1.0) degassing. If</span>
<span class="sd">            any value between &lt;1.0 is chosen, user can also specify the &#39;init_vapor&#39; argument</span>
<span class="sd">            (see below). A value in between 0 and 1 will remove that proportion of vapor at each</span>
<span class="sd">            step. For example, for a value of 0.2, the calculation will remove 20% of the vapor</span>
<span class="sd">            and retain 80% of the vapor at each pressure step.</span>

<span class="sd">        init_vapor: float</span>
<span class="sd">            OPTIONAL. Default value is 0.0. Specifies the amount of vapor (in wt%) coexisting</span>
<span class="sd">            with the melt before degassing.</span>

<span class="sd">        final_pressure: float</span>
<span class="sd">            OPTIONAL. The final pressure on the degassing path, in bars. Ignored if a</span>
<span class="sd">            list or numpy array is passed as the pressure variable. Default is</span>
<span class="sd">            1 bar.</span>

<span class="sd">        steps: int</span>
<span class="sd">            OPTIONAL. Default value is 50. Specifies the number of steps in pressure space at</span>
<span class="sd">            which dissolved volatile concentrations are calculated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas DataFrame object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Finding saturation point... &quot;</span><span class="p">)</span>  <span class="c1"># print start of calculation to terminal</span>
        <span class="n">_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

        <span class="c1"># Normalize sample composition</span>
        <span class="n">_normed_comp</span> <span class="o">=</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">normalization</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">)</span>
        <span class="n">_sample</span><span class="o">.</span><span class="n">change_composition</span><span class="p">(</span><span class="n">_normed_comp</span><span class="p">)</span>
        <span class="n">_sample_dict</span> <span class="o">=</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">()</span>

        <span class="c1"># ------ RESET MELTS ------ #</span>
        <span class="c1"># MELTS needs to be reloaded here. If an unfeasible composition gets set inside of MELTS,</span>
        <span class="c1"># which can happen when running open-system degassing path calcs, the following calls to</span>
        <span class="c1"># MELTS will fail. This prevents that from happening.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span> <span class="o">=</span> <span class="n">equilibrate</span><span class="o">.</span><span class="n">MELTSmodel</span><span class="p">(</span><span class="s2">&quot;1.2.0&quot;</span><span class="p">)</span>

        <span class="c1"># Suppress phases not required in the melts simulation</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_phase_names</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_phase_inclusion_status</span><span class="p">({</span><span class="n">phase</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_phase_inclusion_status</span><span class="p">({</span><span class="s2">&quot;Fluid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Liquid&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">_sample_dict</span><span class="p">)</span>
        <span class="c1"># ------------------------- #</span>

        <span class="c1"># Get saturation pressure</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_saturation_pressure</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">_sample</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                                                  <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pressure</span> <span class="o">==</span> <span class="s2">&quot;saturation&quot;</span> <span class="ow">or</span> <span class="n">pressure</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;SaturationP_bars&quot;</span><span class="p">]:</span>
                <span class="n">SatP_bars</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;SaturationP_bars&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">SatP_bars</span> <span class="o">=</span> <span class="n">pressure</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">SatP_bars</span> <span class="o">-</span> <span class="n">final_pressure</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps</span>
            <span class="n">P_array_bars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">SatP_bars</span><span class="p">,</span> <span class="n">final_pressure</span><span class="p">,</span> <span class="o">-</span><span class="n">step_size</span><span class="p">)</span>
            <span class="n">P_array_MPa</span> <span class="o">=</span> <span class="n">P_array_bars</span><span class="o">/</span><span class="mf">10.0</span>
            <span class="c1"># add last few MPa steps</span>
            <span class="n">P_array_MPa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_array_MPa</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">P_array_MPa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P_array_MPa</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">SatP_bars</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">finalP_bars</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pressure</span><span class="p">)</span>
            <span class="n">step_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">SatP_bars</span> <span class="o">-</span> <span class="n">finalP_bars</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps</span>
            <span class="n">P_array_bars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">SatP_bars</span><span class="p">,</span> <span class="n">finalP_bars</span><span class="p">,</span> <span class="o">-</span><span class="n">step_size</span><span class="p">)</span>
            <span class="n">P_array_MPa</span> <span class="o">=</span> <span class="n">P_array_bars</span><span class="o">/</span><span class="mf">10.0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">P_array_bars</span> <span class="o">=</span> <span class="n">pressure</span>
            <span class="n">P_array_MPa</span> <span class="o">=</span> <span class="n">P_array_bars</span><span class="o">/</span><span class="mf">10.0</span>

        <span class="c1"># # convert number of steps to step size</span>
        <span class="c1"># MPa_step = SatP_MPa / steps</span>
        <span class="c1"># if MPa_step &lt; 1:</span>
        <span class="c1">#     MPa_step = 1</span>

        <span class="n">fl_wtper</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;FluidProportion_wt&quot;</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">fl_wtper</span> <span class="o">&lt;=</span> <span class="n">init_vapor</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">P_array_MPa</span><span class="p">),</span>
                                               <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fl_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>
            <span class="n">liq_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Liquid&quot;</span><span class="p">)</span>
            <span class="n">fl_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>
            <span class="n">fl_wtper</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">fl_mass</span> <span class="o">/</span> <span class="p">(</span><span class="n">fl_mass</span> <span class="o">+</span> <span class="n">liq_mass</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fl_comp</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.0005</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fl_comp</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.0005</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.1</span>
            <span class="n">_sample</span> <span class="o">=</span> <span class="n">sample_class</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">_sample_dict</span><span class="p">)</span>
            <span class="n">_sample_dict</span> <span class="o">=</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">normalization</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">_sample_dict</span><span class="p">)</span>  <span class="c1"># reset MELTS</span>

        <span class="n">press</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">H2Oliq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">CO2liq</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">H2Ofl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">CO2fl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fluid_wtper</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">iterno</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># carriage return to remove previous printed text</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">P_array_MPa</span><span class="p">:</span>
            <span class="c1"># Handle status_bar</span>
            <span class="n">iterno</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="n">iterno</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_array_MPa</span><span class="p">)</span>
            <span class="n">batchfile</span><span class="o">.</span><span class="n">status_bar</span><span class="o">.</span><span class="n">status_bar</span><span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">btext</span><span class="o">=</span><span class="s2">&quot;Calculating degassing path...&quot;</span><span class="p">)</span>

            <span class="n">fl_mass</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">_sample_dict</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">liq_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Liquid&quot;</span><span class="p">)</span>
            <span class="n">fl_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">,</span>
                                                          <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;component&quot;</span><span class="p">)</span>
            <span class="n">liq_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Liquid&quot;</span><span class="p">)</span>
            <span class="n">fl_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s2">&quot;Fluid&quot;</span><span class="p">)</span>
            <span class="n">fl_wtper</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">fl_mass</span> <span class="o">/</span> <span class="p">(</span><span class="n">fl_mass</span> <span class="o">+</span> <span class="n">liq_mass</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fl_mass</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">press</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">H2Oliq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">liq_comp</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">H2Oliq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">CO2liq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">liq_comp</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">CO2liq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">H2Ofl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fl_comp</span><span class="p">[</span><span class="s2">&quot;Water&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">H2Ofl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">CO2fl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fl_comp</span><span class="p">[</span><span class="s2">&quot;Carbon Dioxide&quot;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">CO2fl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">fluid_wtper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fl_wtper</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">liq_comp</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">+</span>
                                           <span class="p">(</span><span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">liq_comp</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">])</span> <span class="o">*</span>
                                           <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fractionate_vapor</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">liq_comp</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">+</span>
                                           <span class="p">(</span><span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">liq_comp</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">])</span> <span class="o">*</span>
                                           <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fractionate_vapor</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
                        <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">_sample_dict</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_sample</span> <span class="o">=</span> <span class="n">sample_class</span><span class="o">.</span><span class="n">Sample</span><span class="p">(</span><span class="n">_sample_dict</span><span class="p">)</span>
            <span class="n">_sample_dict</span> <span class="o">=</span> <span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">normalization</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;wtpt_oxides&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bulk_comp_orig</span><span class="p">)</span>  <span class="c1"># this needs to be reset always!</span>
        <span class="n">open_degassing_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">press</span><span class="p">,</span> <span class="n">H2Oliq</span><span class="p">,</span> <span class="n">CO2liq</span><span class="p">,</span> <span class="n">H2Ofl</span><span class="p">,</span> <span class="n">CO2fl</span><span class="p">,</span>
                                                  <span class="n">fluid_wtper</span><span class="p">)),</span>
                                         <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Pressure_bars&quot;</span><span class="p">,</span>
                                                  <span class="s2">&quot;H2O_liq&quot;</span><span class="p">,</span>
                                                  <span class="s2">&quot;CO2_liq&quot;</span><span class="p">,</span>
                                                  <span class="s2">&quot;XH2O_fl&quot;</span><span class="p">,</span>
                                                  <span class="s2">&quot;XCO2_fl&quot;</span><span class="p">,</span>
                                                  <span class="s2">&quot;FluidProportion_wt&quot;</span><span class="p">])</span>

        <span class="n">open_degassing_df</span> <span class="o">=</span> <span class="n">open_degassing_df</span><span class="p">[</span><span class="n">open_degassing_df</span><span class="o">.</span><span class="n">CO2_liq</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="n">open_degassing_df</span> <span class="o">=</span> <span class="n">open_degassing_df</span><span class="p">[</span><span class="n">open_degassing_df</span><span class="o">.</span><span class="n">H2O_liq</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">open_degassing_df</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Kayla Iacovino and Simon Matthews.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>