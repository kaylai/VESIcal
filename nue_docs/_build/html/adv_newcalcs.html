

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Writing new calculations for existing models &mdash; VESIcal 1.2.6 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=77553476" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=010db75e"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">ChangeLog</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About VESIcal</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">Models in VESIcal</a></li>
<li class="toctree-l1"><a class="reference internal" href="integration.html">Integration with Thermobar</a></li>
<li class="toctree-l1"><a class="reference internal" href="workshops.html">Workshops and Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="codedoc.html">VESIcal Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ’s</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">MIT Licence</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">ChangeLog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">VESIcal</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Writing new calculations for existing models</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/adv_newcalcs.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="writing-new-calculations-for-existing-models">
<h1><a class="toc-backref" href="#id3" role="doc-backlink">Writing new calculations for existing models</a><a class="headerlink" href="#writing-new-calculations-for-existing-models" title="Link to this heading"></a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#writing-new-calculations-for-existing-models" id="id3">Writing new calculations for existing models</a></p>
<ul>
<li><p><a class="reference internal" href="#creating-and-modifying-model-objects" id="id4">Creating and modifying model objects</a></p>
<ul>
<li><p><a class="reference internal" href="#creating-new-calculations-using-an-existing-model" id="id5">Creating new calculations using an existing model</a></p></li>
<li><p><a class="reference internal" href="#some-notes-about-our-new-calculation" id="id6">Some notes about our new calculation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#working-with-batchfile-objects" id="id7">Working with BatchFile objects</a></p></li>
</ul>
</li>
</ul>
</nav>
<hr class="docutils" />
<p><strong>Download the Jupyter notebook (Right click and “Save as…”)</strong> <a class="reference external" href="https://github.com/kaylai/VESIcal/blob/master/docs/jupyter_notebooks/adv_newcalcs.ipynb">here</a>.</p>
<hr class="docutils" />
<p>Any model within VESIcal can be duplicated and then modified. New calculation methods that rely on the pre-existing structure within VESIcal, can be easily added. An example is shown here for a new method, <code class="xref py py-meth docutils literal notranslate"><span class="pre">calculate_dissolved_CO2()</span></code>. This method will be used to calculate the dissolved CO2 concentration, in wt%, of a mixed fluid (H2O-CO2) saturated magma with a known dissolved H2O concentration, pressure, temperature, and bulk composition. This magma would thus be undersaturated in pure H2O but saturated in mixed H2O-CO2 fluid.</p>
<section id="creating-and-modifying-model-objects">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Creating and modifying model objects</a><a class="headerlink" href="#creating-and-modifying-model-objects" title="Link to this heading"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">VESIcal</span> <span class="k">as</span> <span class="nn">v</span>
</pre></div>
</div>
<p>First, we duplicate the MagmaSat model object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># duplicate the MagmaSat model into a new object called mymodel</span>
<span class="n">mymodel</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">magmasat</span><span class="o">.</span><span class="n">MagmaSat</span><span class="p">()</span>
</pre></div>
</div>
<p>We now have a new model object, called mymodel, that behaves exactly as the MagmaSat model would. You can test this by performing any VESIcal calculation and setting the argument ‘model’ to be ‘mymodel’. Let’s first create a sample to test this with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a sample to test new method</span>
<span class="n">testsample</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">Sample</span><span class="p">({</span><span class="s1">&#39;SiO2&#39;</span><span class="p">:</span>    <span class="mf">47.95</span><span class="p">,</span>
                       <span class="s1">&#39;TiO2&#39;</span><span class="p">:</span>    <span class="mf">1.67</span><span class="p">,</span>
                       <span class="s1">&#39;Al2O3&#39;</span><span class="p">:</span>   <span class="mf">17.32</span><span class="p">,</span>
                       <span class="s1">&#39;FeO&#39;</span><span class="p">:</span>     <span class="mf">10.24</span><span class="p">,</span>
                       <span class="s1">&#39;Fe2O3&#39;</span><span class="p">:</span>   <span class="mf">0.1</span><span class="p">,</span>
                       <span class="s1">&#39;MgO&#39;</span><span class="p">:</span>     <span class="mf">5.76</span><span class="p">,</span>
                       <span class="s1">&#39;CaO&#39;</span><span class="p">:</span>     <span class="mf">10.93</span><span class="p">,</span>
                       <span class="s1">&#39;Na2O&#39;</span><span class="p">:</span>    <span class="mf">3.45</span><span class="p">,</span>
                       <span class="s1">&#39;K2O&#39;</span><span class="p">:</span>     <span class="mf">1.99</span><span class="p">,</span>
                       <span class="s1">&#39;P2O5&#39;</span><span class="p">:</span>    <span class="mf">0.51</span><span class="p">,</span>
                       <span class="s1">&#39;MnO&#39;</span><span class="p">:</span>     <span class="mf">0.1</span><span class="p">,</span>
                       <span class="s1">&#39;H2O&#39;</span><span class="p">:</span>     <span class="mf">2.0</span>
                    <span class="p">})</span>
</pre></div>
</div>
<p>Now, let’s try calculating the saturation pressure of testsample at 1000 degrees C using the mymodel object we’ve just created.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">satP</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">calculate_saturation_pressure</span><span class="p">(</span><span class="n">sample</span><span class="o">=</span><span class="n">testsample</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">mymodel</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The saturation pressure is &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">satP</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; bars.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">saturation</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="mi">430</span> <span class="n">bars</span><span class="o">.</span>
</pre></div>
</div>
<section id="creating-new-calculations-using-an-existing-model">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Creating new calculations using an existing model</a><a class="headerlink" href="#creating-new-calculations-using-an-existing-model" title="Link to this heading"></a></h3>
<p>Now, let’s create a new calculation (called a method) within the framework of mymodel, which is a duplicate of MagmaSat. In the case of MagmaSat, the MELTS model also needs to be defined separately (with other models, this step is unnecessary).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import MELTS preamble (copy-paste from magmasat.py)</span>
<span class="kn">from</span> <span class="nn">thermoengine</span> <span class="kn">import</span> <span class="n">equilibrate</span>

<span class="c1"># -------------- MELTS preamble --------------- #</span>
<span class="c1"># instantiate thermoengine equilibrate MELTS instance</span>
<span class="n">melts</span> <span class="o">=</span> <span class="n">equilibrate</span><span class="o">.</span><span class="n">MELTSmodel</span><span class="p">(</span><span class="s1">&#39;1.2.0&#39;</span><span class="p">)</span>

<span class="c1"># Suppress phases not required in the melts simulation</span>
<span class="n">phases</span> <span class="o">=</span> <span class="n">melts</span><span class="o">.</span><span class="n">get_phase_names</span><span class="p">()</span>
<span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
    <span class="n">melts</span><span class="o">.</span><span class="n">set_phase_inclusion_status</span><span class="p">({</span><span class="n">phase</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<span class="n">melts</span><span class="o">.</span><span class="n">set_phase_inclusion_status</span><span class="p">({</span><span class="s1">&#39;Fluid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Liquid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="c1"># --------------------------------------------- #</span>
</pre></div>
</div>
<p>Now that MELTS is defined, we can get to work creating a new calculation. Below, we have taken the code from MagmaSat’s <code class="xref py py-meth docutils literal notranslate"><span class="pre">calculate_dissolved_volatiles()</span></code> method and adjusted it to meet our needs. We begin with a magma that we know to be pure-H2O undersaturated but mixed H2O-CO2 saturated, with known dissolved H2O concentration in wt%, pressure in bars, and temperature in degrees C. The goal is to write a method to calculate the concentration of dissolved CO2 necessary to acheive mixed H2O-CO2 saturation at the given conditions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># write a new method to add to our mymodel object</span>
<span class="c1"># this method will hold H2O constant and calculate dissolved CO2 at given P, T</span>
<span class="c1"># this is a modification of the existing calculate_dissolved_volatiles() method</span>

<span class="k">def</span> <span class="nf">calculate_dissolved_CO2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span>
                            <span class="n">H2O_liq</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the amount of CO2 dissolved in a magma at saturation at the given P/T</span>
<span class="sd">        conditions and given dissolved H2O.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample:     Sample class</span>
<span class="sd">            Magma major element composition.</span>

<span class="sd">        temperature: float or int</span>
<span class="sd">            Temperature, in degrees C.</span>

<span class="sd">        presure: float or int</span>
<span class="sd">            Pressure, in bars.</span>

<span class="sd">        H2O_liq: float or int</span>
<span class="sd">            Dissolved H2O concentration, in wt%</span>

<span class="sd">        verbose: bool</span>
<span class="sd">            OPTIONAL: Default is False. If set to True, returns H2O and CO2 concentration in the</span>
<span class="sd">            melt, H2O and CO2 concentration in the fluid, mass of the fluid in grams, and</span>
<span class="sd">            proportion of fluid in the system in wt%.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            A dictionary of dissolved volatile concentrations in wt% with keys H2O and CO2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">H2O_liq</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">H2O_liq</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">core</span><span class="o">.</span><span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;H2O_liq must be type int or float&quot;</span><span class="p">)</span>

        <span class="n">pressureMPa</span> <span class="o">=</span> <span class="n">pressure</span> <span class="o">/</span> <span class="mf">10.0</span>

        <span class="c1"># coarse search</span>
        <span class="n">H2O_bulk</span> <span class="o">=</span> <span class="n">H2O_liq</span>
        <span class="n">CO2_bulk</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">fluid_mass</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">while</span> <span class="n">fluid_mass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">CO2_bulk</span> <span class="o">+=</span> <span class="mf">0.01</span>
            <span class="n">fluid_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fluid_mass</span><span class="p">(</span><span class="n">_sample</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">H2O_bulk</span><span class="p">,</span> <span class="n">CO2_bulk</span><span class="p">)</span>

        <span class="c1"># calculated dissolved H2O, then increment up</span>
        <span class="n">H2O_diss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">H2O_diss</span> <span class="o">&lt;</span> <span class="n">H2O_liq</span><span class="p">:</span>
            <span class="n">_sample</span><span class="o">.</span><span class="n">change_composition</span><span class="p">({</span><span class="s1">&#39;H2O&#39;</span><span class="p">:</span> <span class="n">H2O_bulk</span><span class="p">,</span> <span class="s1">&#39;CO2&#39;</span><span class="p">:</span> <span class="n">CO2_bulk</span><span class="p">},</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;wtpt_oxides&#39;</span><span class="p">)</span>
            <span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;wtpt_oxides&#39;</span><span class="p">,</span>
                                                               <span class="n">normalization</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">liquid_comp</span> <span class="o">=</span> <span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s1">&#39;Liquid&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;oxide_wt&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;H2O&quot;</span> <span class="ow">in</span> <span class="n">liquid_comp</span><span class="p">:</span>
                <span class="n">H2O_diss</span> <span class="o">=</span> <span class="n">liquid_comp</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H2O_diss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># changing this value changes how close to the original</span>
            <span class="c1"># known H2O value the resulting H2O_liquid wt% will be</span>
            <span class="n">H2O_bulk</span> <span class="o">+=</span> <span class="mf">0.001</span>

        <span class="n">H2O_val</span> <span class="o">=</span> <span class="n">H2O_bulk</span>
        <span class="n">CO2_val</span> <span class="o">=</span> <span class="n">CO2_bulk</span>

        <span class="c1"># ------ Get calculated values ------ #</span>
        <span class="n">_sample</span><span class="o">.</span><span class="n">change_composition</span><span class="p">({</span><span class="s1">&#39;H2O&#39;</span><span class="p">:</span> <span class="n">H2O_val</span><span class="p">,</span> <span class="s1">&#39;CO2&#39;</span><span class="p">:</span> <span class="n">CO2_val</span><span class="p">},</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;wtpt_oxides&#39;</span><span class="p">)</span>
        <span class="n">melts</span><span class="o">.</span><span class="n">set_bulk_composition</span><span class="p">(</span><span class="n">_sample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s1">&#39;wtpt_oxides&#39;</span><span class="p">,</span>
                                                           <span class="n">normalization</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">melts</span><span class="o">.</span><span class="n">equilibrate_tp</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">initialize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressureMPa</span><span class="p">,</span> <span class="n">xmlout</span><span class="p">)</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fluid_mass</span> <span class="o">=</span> <span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s1">&#39;Fluid&#39;</span><span class="p">)</span>
        <span class="n">system_mass</span> <span class="o">=</span> <span class="n">melts</span><span class="o">.</span><span class="n">get_mass_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s1">&#39;System&#39;</span><span class="p">)</span>
        <span class="n">liquid_comp</span> <span class="o">=</span> <span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s1">&#39;Liquid&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;oxide_wt&#39;</span><span class="p">)</span>
        <span class="n">fluid_comp</span> <span class="o">=</span> <span class="n">melts</span><span class="o">.</span><span class="n">get_composition_of_phase</span><span class="p">(</span><span class="n">xmlout</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="s1">&#39;Fluid&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;component&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;H2O&quot;</span> <span class="ow">in</span> <span class="n">liquid_comp</span><span class="p">:</span>
            <span class="n">H2O_liq</span> <span class="o">=</span> <span class="n">liquid_comp</span><span class="p">[</span><span class="s2">&quot;H2O&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H2O_liq</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;CO2&quot;</span> <span class="ow">in</span> <span class="n">liquid_comp</span><span class="p">:</span>
            <span class="n">CO2_liq</span> <span class="o">=</span> <span class="n">liquid_comp</span><span class="p">[</span><span class="s2">&quot;CO2&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CO2_liq</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;Water&quot;</span> <span class="ow">in</span> <span class="n">fluid_comp</span><span class="p">:</span>
            <span class="n">H2O_fl</span> <span class="o">=</span> <span class="n">fluid_comp</span><span class="p">[</span><span class="s2">&quot;Water&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H2O_fl</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="s2">&quot;Carbon Dioxide&quot;</span> <span class="ow">in</span> <span class="n">fluid_comp</span><span class="p">:</span>
            <span class="n">CO2_fl</span> <span class="o">=</span> <span class="n">fluid_comp</span><span class="p">[</span><span class="s2">&quot;Carbon Dioxide&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CO2_fl</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">XH2O_fluid</span> <span class="o">=</span> <span class="n">H2O_fl</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">temperature</span><span class="p">,</span> <span class="s2">&quot;pressure&quot;</span><span class="p">:</span> <span class="n">pressure</span><span class="p">,</span>
                    <span class="s2">&quot;H2O_liq&quot;</span><span class="p">:</span> <span class="n">H2O_liq</span><span class="p">,</span> <span class="s2">&quot;CO2_liq&quot;</span><span class="p">:</span> <span class="n">CO2_liq</span><span class="p">,</span>
                    <span class="s2">&quot;XH2O_fl&quot;</span><span class="p">:</span> <span class="n">H2O_fl</span><span class="p">,</span> <span class="s2">&quot;XCO2_fl&quot;</span><span class="p">:</span> <span class="n">CO2_fl</span><span class="p">,</span>
                    <span class="s2">&quot;FluidProportion_wt&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="o">*</span><span class="n">fluid_mass</span><span class="o">/</span><span class="n">system_mass</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;CO2_liq&quot;</span><span class="p">:</span> <span class="n">CO2_liq</span><span class="p">,</span> <span class="s2">&quot;H2O_liq&quot;</span><span class="p">:</span> <span class="n">H2O_liq</span><span class="p">}</span>
</pre></div>
</div>
<p>In order to bind our newly created method to mymodel (in other words, in order to allow mymodel to access and execute the code we have just written), we use python’s universal .get method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># add our new method to mymodel</span>
<span class="n">mymodel</span><span class="o">.</span><span class="n">calculate_dissolved_CO2</span> <span class="o">=</span> <span class="n">calculate_dissolved_CO2</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">mymodel</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, let’s test our new method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mymodel</span><span class="o">.</span><span class="n">calculate_dissolved_CO2</span><span class="p">(</span><span class="n">testsample</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="mf">5000.0</span><span class="p">,</span>
                                <span class="n">temperature</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span>
                                <span class="n">H2O_liq</span><span class="o">=</span><span class="n">testsample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">()[</span><span class="s1">&#39;H2O&#39;</span><span class="p">],</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;temperature&#39;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">,</span>
 <span class="s1">&#39;pressure&#39;</span><span class="p">:</span> <span class="mf">5000.0</span><span class="p">,</span>
 <span class="s1">&#39;H2O_liq&#39;</span><span class="p">:</span> <span class="mf">2.00178003974518</span><span class="p">,</span>
 <span class="s1">&#39;CO2_liq&#39;</span><span class="p">:</span> <span class="mf">0.52008219111891</span><span class="p">,</span>
 <span class="s1">&#39;XH2O_fl&#39;</span><span class="p">:</span> <span class="mf">0.146985466738443</span><span class="p">,</span>
 <span class="s1">&#39;XCO2_fl&#39;</span><span class="p">:</span> <span class="mf">0.853014533261557</span><span class="p">,</span>
 <span class="s1">&#39;FluidProportion_wt&#39;</span><span class="p">:</span> <span class="mf">0.007595399812658153</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="some-notes-about-our-new-calculation">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Some notes about our new calculation</a><a class="headerlink" href="#some-notes-about-our-new-calculation" title="Link to this heading"></a></h3>
<p>Notice that the final output dissolved H2O concentration matches our given H2O concentration of 2.0 wt% to within ~0.001 wt%. This final output value can be made to match much more closely to the given H2O concentration by adjusting one line of code. See comment “changing this value changes how close to the original known H2O value the resulting H2O_liquid wt% will be”.</p>
</section>
</section>
<section id="working-with-batchfile-objects">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Working with BatchFile objects</a><a class="headerlink" href="#working-with-batchfile-objects" title="Link to this heading"></a></h2>
<p>Surely, this function is most useful when it can be applied not only to single Sample objects but also to BatchFile objects, such that an entire dataset can be evaluated by the new method at once. In the future, VESIcal will have built-in functions for adding custom code to VESIcal’s own batchmodel module. For now, we will demonstrated how to write a for loop to apply our custom <cite>calculate_dissolved_CO2</cite> function to each sample in a BatchFile.</p>
<p>First, let’s import a file as a BatchFile object. We are using the example_data.xlsx file published with the VESIcal manuscript. You can download the file <a class="reference external" href="https://github.com/kaylai/VESIcal/tree/master/manuscript/Supplement/Datasets">here</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import our file and save it to object named myfile</span>
<span class="n">myfile</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">BatchFile</span><span class="p">(</span><span class="s1">&#39;example_data.xlsx&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, let’s construct the loop. We need to work with <cite>myfile</cite> as a pandas dataframe, so let’s grab the data out of the BatchFile object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mydata</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

<span class="c1"># I&#39;m going to take only the first three rows of this file to speed things up</span>
<span class="n">mydata</span> <span class="o">=</span> <span class="n">mydata</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="nb">type</span><span class="p">(</span><span class="n">mydata</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>
</pre></div>
</div>
<p>Now, we can iterate over the dataframe following rules set by python pandas.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># first create an empty list to store our results</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># next, iterate over the dataframe</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mydata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">currentsample</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">get_sample_composition</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">asSampleClass</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">currentresult</span> <span class="o">=</span> <span class="n">mymodel</span><span class="o">.</span><span class="n">calculate_dissolved_CO2</span><span class="p">(</span><span class="n">currentsample</span><span class="p">,</span>
                                                    <span class="n">pressure</span><span class="o">=</span><span class="mf">5000.0</span><span class="p">,</span>
                                                    <span class="n">temperature</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span>
                                                    <span class="n">H2O_liq</span><span class="o">=</span><span class="n">currentsample</span><span class="o">.</span><span class="n">get_composition</span><span class="p">()[</span><span class="s1">&#39;H2O&#39;</span><span class="p">],</span>
                                                    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; if you want to grab pressure or temperature values from the BatchFile object</span>
<span class="sd">     for example, if each sample has a &quot;Pressure&quot; and &quot;Temperature&quot; column, use:</span>
<span class="sd">     currentresult = mymodel.calculate_dissolved_CO2(currentsample,</span>
<span class="sd">                                                    pressure=row[&quot;Pressure&quot;],</span>
<span class="sd">                                                    temperature=row[&quot;Temperature&quot;],</span>
<span class="sd">                                                    H2O_liq=testsample.get_composition()[&#39;H2O&#39;],</span>
<span class="sd">                                                    verbose=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># next, append the result to our empty list</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currentresult</span><span class="p">)</span>

<span class="c1"># To more easily work with this data outside of VESIcal,</span>
<span class="c1"># let&#39;s save our new data to a dataframe and export that</span>
<span class="c1"># to an xlsx file</span>
<span class="n">results_frame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">results_frame</span><span class="p">[</span><span class="s1">&#39;Label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mydata</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">results_frame</span><span class="p">[</span><span class="s1">&#39;Modeled_Temperature(C)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<span class="n">results_frame</span><span class="p">[</span><span class="s1">&#39;Modeled_Pressure(bars)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<span class="n">results_frame</span><span class="p">[</span><span class="s1">&#39;H2O_liq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;H2O_liq&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<span class="n">results_frame</span><span class="p">[</span><span class="s1">&#39;CO2_liq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;CO2_liq&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<span class="n">results_frame</span><span class="p">[</span><span class="s1">&#39;XH2O_fl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;XH2O_fl&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<span class="n">results_frame</span><span class="p">[</span><span class="s1">&#39;XCO2_fl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;XCO2_fl&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
<span class="n">results_frame</span><span class="p">[</span><span class="s1">&#39;FluidProportion_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;FluidProportion_wt&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># view the dataframe we just made</span>
<span class="n">results_frame</span>
</pre></div>
</div>
<table class="docutils align-default" id="id2">
<caption><span class="caption-text">Output</span><a class="headerlink" href="#id2" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Label</p></th>
<th class="head"><p>Modeled_Temperature(C)</p></th>
<th class="head"><p>Modeled_Pressure(bars)</p></th>
<th class="head"><p>H2O_liq</p></th>
<th class="head"><p>CO2_liq</p></th>
<th class="head"><p>XH2O_fl</p></th>
<th class="head"><p>XCO2_fl</p></th>
<th class="head"><p>FluidProportion_wt</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Kil3-6_1a</p></td>
<td><p>1000.0</p></td>
<td><p>5000.0</p></td>
<td><p>0.426202675854206</p></td>
<td><p>0.346391834832634</p></td>
<td><p>0.01014057366353</p></td>
<td><p>0.98985942633647</p></td>
<td><p>0.0024053732535706425</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Kil3-6_3a</p></td>
<td><p>1000.0</p></td>
<td><p>5000.0</p></td>
<td><p>0.427505689302417</p></td>
<td><p>0.340686330025398</p></td>
<td><p>0.0097938748143447</p></td>
<td><p>0.990206125185655</p></td>
<td><p>0.008166858670603938</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Kil3-6_4a</p></td>
<td><p>1000.0</p></td>
<td><p>5000.0</p></td>
<td><p>0.439361359410916</p></td>
<td><p>0.311653237380262</p></td>
<td><p>0.0103497013397924</p></td>
<td><p>0.989650298660208</p></td>
<td><p>0.007386845512103998</p></td>
</tr>
</tbody>
</table>
<p>Finally, we can output this dataframe as an xlsx file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># export that dataframe to an xlsx file</span>
<span class="n">results_frame</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">&quot;Modeling_Results.xlsx&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Kayla Iacovino and Simon Matthews.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>